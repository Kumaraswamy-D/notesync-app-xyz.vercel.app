<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>KP üíñ Private Space</title>

<style>
body{
  margin:0;
  font-family: Arial;
  background:#0c1222;
  color:white;
  text-align:center;
}

.container{ padding:20px; }

button{
  padding:8px 15px;
  margin:5px;
  border:none;
  border-radius:8px;
  background:#d4af37;
  cursor:pointer;
}

input{
  padding:8px;
  margin:5px;
  border-radius:8px;
  border:none;
}

.section{ display:none; }
.active{ display:block; }

.card{
  background:#1a2238;
  padding:15px;
  border-radius:12px;
  margin:10px 0;
}

#chatBox,#specialBox{
  background:#111;
  height:220px;
  overflow-y:auto;
  padding:10px;
  border-radius:10px;
  text-align:left;
}
</style>
</head>

<body>

<div class="container">

<h2>üíñ Kumaraswamy ‚ù§Ô∏è Pooja üíñ</h2>

<!-- LOGIN -->
<div id="loginDiv">
  <input type="email" id="emailInput" placeholder="Email"><br>
  <input type="password" id="passwordInput" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
</div>

<!-- APP -->
<div id="appDiv" style="display:none;">

<div>
  <button onclick="showSection('home')">Home</button>
  <button onclick="showSection('chat')">Chat</button>
  <button onclick="showSection('special')">Special Box</button>
  <button id="logoutBtn">Logout</button>
</div>

<!-- HOME -->
<div id="home" class="section active">

<div class="card">
<p id="loveDays"></p>
</div>

<div class="card">
<p id="birthdayCounter"></p>
</div>

<div class="card">
<p id="onlineStatus"></p>
</div>

</div>

<!-- CHAT -->
<div id="chat" class="section">
<div id="chatBox"></div>
<input type="text" id="messageInput" placeholder="Type message">
<button id="sendBtn">Send</button>
</div>

<!-- SPECIAL -->
<div id="special" class="section">
<div id="specialBox"></div>
<input type="text" id="specialInput" placeholder="Secret message">
<button id="specialBtn">Send</button>
</div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDEl579k9r9NxIVss_QtQTNLoa25CGGSbI",
  authDomain: "notesync-5e7ed.firebaseapp.com",
  projectId: "notesync-5e7ed",
  storageBucket: "notesync-5e7ed.firebasestorage.app",
  messagingSenderId: "486342879531",
  appId: "1:486342879531:web:76ed522f873d1ecca67d6e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const allowedUsers = {
  "kumaraswamyd2005@gmail.com": "Kumaraswamy ‚ù§Ô∏è",
  "poojaprasanna089@gmail.com": "Pooja ‚ù§Ô∏è"
};

const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

const loginDiv = document.getElementById("loginDiv");
const appDiv = document.getElementById("appDiv");

loginBtn.onclick = async () => {
  if(!allowedUsers[emailInput.value]){
    alert("Not allowed user");
    return;
  }
  await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
};

logoutBtn.onclick = async () => {
  if(auth.currentUser){
    await setDoc(doc(db,"users",auth.currentUser.email),{status:"offline"});
    await signOut(auth);
  }
};

window.showSection = function(id){
  document.querySelectorAll(".section").forEach(sec=>sec.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

document.getElementById("sendBtn").onclick = async () => {
  const text = document.getElementById("messageInput").value;
  if(text==="") return;

  await addDoc(collection(db,"messages"),{
    text,
    user: allowedUsers[auth.currentUser.email],
    time: Date.now()
  });

  document.getElementById("messageInput").value="";
};

document.getElementById("specialBtn").onclick = async () => {
  const text = document.getElementById("specialInput").value;
  if(text==="") return;

  await addDoc(collection(db,"specialMessages"),{
    text,
    user: allowedUsers[auth.currentUser.email],
    time: Date.now()
  });

  document.getElementById("specialInput").value="";
};

function updateLoveDays(){
  const start = new Date("2023-11-25");
  const now = new Date();
  const diff = Math.floor((now-start)/(1000*60*60*24));
  document.getElementById("loveDays").innerText = "üíò Together for " + diff + " Days";
}

function updateBirthday(){
  const today = new Date();
  let bday = new Date(today.getFullYear(),1,19);
  if(today > bday) bday.setFullYear(today.getFullYear()+1);
  const diff = Math.ceil((bday-today)/(1000*60*60*24));
  document.getElementById("birthdayCounter").innerText = "üéÇ Kumar Birthday in " + diff + " Days";
}

onAuthStateChanged(auth,user=>{
  if(user){
    loginDiv.style.display="none";
    appDiv.style.display="block";

    setDoc(doc(db,"users",user.email),{status:"online"});

    updateLoveDays();
    updateBirthday();

    const q = query(collection(db,"messages"),orderBy("time"));
    onSnapshot(q,snapshot=>{
      const box = document.getElementById("chatBox");
      box.innerHTML="";
      snapshot.forEach(doc=>{
        const data = doc.data();
        box.innerHTML += `<p><b>${data.user}:</b> ${data.text}</p>`;
      });
    });

    const sp = query(collection(db,"specialMessages"),orderBy("time"));
    onSnapshot(sp,snapshot=>{
      const box = document.getElementById("specialBox");
      box.innerHTML="";
      snapshot.forEach(docu=>{
        const data = docu.data();
        box.innerHTML += `<p>${data.user}: ${data.text} 
        <button onclick="deleteSpecial('${docu.id}')">Read</button></p>`;
      });
    });

  }else{
    loginDiv.style.display="block";
    appDiv.style.display="none";
  }
});

window.deleteSpecial = async function(id){
  await deleteDoc(doc(db,"specialMessages",id));
};

</script>

</body>
</html>
