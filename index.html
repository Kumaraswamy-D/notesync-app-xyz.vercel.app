<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NoteSync</title>

<style>
body {
  font-family: Arial;
  text-align: center;
  background: #f4f6f9;
}

h2 {
  color: #333;
}

#chatBox {
  height: 300px;
  overflow-y: scroll;
  background: white;
  margin: 10px;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  text-align: left;
}

input, button {
  padding: 10px;
  margin: 5px;
  border-radius: 5px;
  border: none;
  width: 90%;
  max-width: 300px;
}

button {
  background: #4CAF50;
  color: white;
}

img {
  max-width: 200px;
  border-radius: 10px;
  margin-top: 5px;
}
</style>
</head>
<body>

<h2>NoteSync</h2>

<div id="loginDiv">
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>

<div id="appDiv" style="display:none;">

  <h3>Chat</h3>
  <div id="chatBox"></div>

  <input type="text" id="message" placeholder="Type message"><br>
  <input type="file" id="imageInput"><br>
  <button onclick="sendMessage()">Send</button>
  <button onclick="logout()">Logout</button>

  <hr>

  <h3>Celebrations ðŸŽ‰</h3>
  <input type="text" id="eventName" placeholder="Event name">
  <input type="date" id="eventDate"><br>
  <button onclick="addEvent()">Add Event</button>

  <div id="eventList"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDEl579k9r9NxIVss_QtQTNLoa25CGGSbI",
  authDomain: "notesync-5e7ed.firebaseapp.com",
  projectId: "notesync-5e7ed",
  storageBucket: "notesync-5e7ed.firebasestorage.app",
  messagingSenderId: "486342879531",
  appId: "1:486342879531:web:76ed522f873d1ecca67d6e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.login = function() {
  const emailVal = document.getElementById("email").value;
  const passwordVal = document.getElementById("password").value;

  signInWithEmailAndPassword(auth, emailVal, passwordVal)
  .catch(error => alert(error.message));
}

window.logout = function() {
  signOut(auth);
}

window.sendMessage = async function() {
  const text = document.getElementById("message").value;
  const file = document.getElementById("imageInput").files[0];

  let imageData = "";

  if (file) {
    const reader = new FileReader();
    reader.onload = async function(e) {
      imageData = e.target.result;
      await saveMessage(text, imageData);
    };
    reader.readAsDataURL(file);
  } else {
    await saveMessage(text, "");
  }

  document.getElementById("message").value = "";
  document.getElementById("imageInput").value = "";
}

async function saveMessage(text, imageData) {
  if(text.trim() === "" && imageData === "") return;

  await addDoc(collection(db, "messages"), {
    text: text,
    image: imageData,
    user: auth.currentUser.email,
    time: Date.now()
  });
}

window.addEvent = async function() {
  const name = document.getElementById("eventName").value;
  const date = document.getElementById("eventDate").value;

  if(name && date) {
    await addDoc(collection(db, "events"), {
      name,
      date
    });
  }

  document.getElementById("eventName").value = "";
  document.getElementById("eventDate").value = "";
}

onAuthStateChanged(auth, user => {
  const loginDiv = document.getElementById("loginDiv");
  const appDiv = document.getElementById("appDiv");
  const chatBox = document.getElementById("chatBox");
  const eventList = document.getElementById("eventList");

  if (user) {
    loginDiv.style.display = "none";
    appDiv.style.display = "block";

    const q = query(collection(db, "messages"), orderBy("time"));
    onSnapshot(q, snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        let msg = doc.data();
        chatBox.innerHTML += `<p><b>${msg.user}:</b> ${msg.text}</p>`;
        if(msg.image){
          chatBox.innerHTML += `<img src="${msg.image}" width="200">`;
        }
      });
    });

    onSnapshot(collection(db, "events"), snapshot => {
      eventList.innerHTML = "";
      snapshot.forEach(doc => {
        let e = doc.data();
        eventList.innerHTML += `<p>${e.name} - ${e.date}</p>`;
      });
    });

  } else {
    loginDiv.style.display = "block";
    appDiv.style.display = "none";
  }
});
</script>

</body>
</html>

